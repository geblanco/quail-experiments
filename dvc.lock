schema: '2.0'
stages:
  dl_quail:
    cmd: ./src/etl/dl_quail.sh
    deps:
    - path: src/etl/dl_quail.sh
      md5: 35c895bd0b066481c8f7fba6dd57a0cb
      size: 824
    outs:
    - path: data/quail/dev.json
      md5: 710c954716143d6d3c8c2ef2044f5c0c
      size: 955449
    - path: data/quail/dev_answers.json
      md5: 1665e633ee7aa0183a45a3749e4e061b
      size: 46710
    - path: data/quail/eval.py
      md5: cab53a1ed0c7248b036be788fa60ec3c
      size: 1446
    - path: data/quail/train.json
      md5: 5409940d9b8479dc51fe56c9b5607344
      size: 4498702
    - path: data/quail/train_answers.json
      md5: c1b17d1e9bb8bbce4b28c253e5167001
      size: 199358
  tr_quail_dev_to_race:
    cmd: src/etl/preprocess_quail_to_race.py data/quail/dev.json data/quail/dev_answers.json
      -o data/quail_race_fmt/dev.json
    deps:
    - path: data/quail/dev.json
      md5: 710c954716143d6d3c8c2ef2044f5c0c
      size: 955449
    - path: data/quail/dev_answers.json
      md5: 1665e633ee7aa0183a45a3749e4e061b
      size: 46710
    - path: src/etl/preprocess_quail_to_race.py
      md5: d85a3aa72f907adfdef52155b94d55b5
      size: 3261
    outs:
    - path: data/quail_race_fmt/dev.json
      md5: b2573225520d6ae103b7b1f899ebd433
      size: 611156
  tr_quail_train_to_race:
    cmd: src/etl/preprocess_quail_to_race.py data/quail/train.json data/quail/train_answers.json
      -o data/quail_race_fmt/train.json
    deps:
    - path: data/quail/train.json
      md5: 5409940d9b8479dc51fe56c9b5607344
      size: 4498702
    - path: data/quail/train_answers.json
      md5: c1b17d1e9bb8bbce4b28c253e5167001
      size: 199358
    - path: src/etl/preprocess_quail_to_race.py
      md5: d85a3aa72f907adfdef52155b94d55b5
      size: 3261
    outs:
    - path: data/quail_race_fmt/train.json
      md5: 6c67d6a9e3c054cf471ef467fbf23e26
      size: 2863957
  tr_quail_dev_no_empty_answers:
    cmd: python src/etl/choices/reformat_dataset.py -d ./data/quail_race_fmt -o ./data/quail_no_empty_answers
      -s dev --no_answer_text "not enough information" --keep_matching_text --index_list_path
      ./data/quail_no_empty_answers/dev_index_list.json
    deps:
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    - path: src/etl/choices/reformat_dataset.py
      md5: e8e3c8d3f5afcfc5c8c9fda62296ac7d
      size: 4721
    outs:
    - path: ./data/quail_no_empty_answers/dev_index_list.json
      md5: df9910f3a043308666bffbeb9fcebe5e
      size: 30297
    - path: data/quail_no_empty_answers/dev.json
      md5: 0527f4f70f20380b3eb7b506c063a7d8
      size: 554890
  tr_quail_train_no_empty_answers:
    cmd: python src/etl/choices/reformat_dataset.py -d data/quail_race_fmt -o data/quail_no_empty_answers
      -s train --no_answer_text "not enough information"
    deps:
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    - path: src/etl/choices/reformat_dataset.py
      md5: e8e3c8d3f5afcfc5c8c9fda62296ac7d
      size: 4721
    outs:
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
  dl_models:
    cmd: python ./src/etl/dl_models.py -m bert-base-uncased --overwrite
    deps:
    - path: src/etl/dl_models.py
      md5: c2ca665ea793afe968fff649f0e04717
      size: 2452
    outs:
    - path: data/models/bert-base-uncased
      md5: be46589e12f830a3e7955451e37136ae.dir
      size: 438215920
      nfiles: 5
  bert-train-no-empty-answers:
    cmd: ./src/processing/run.sh data/specs/bert-train-no-empty-answers_experiment.json
    deps:
    - path: data/models/bert-base-uncased
      md5: be46589e12f830a3e7955451e37136ae.dir
      size: 438215920
      nfiles: 5
    - path: data/quail_no_empty_answers/dev.json
      md5: 0527f4f70f20380b3eb7b506c063a7d8
      size: 554890
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
    - path: src/processing/run.sh
      md5: 311ef43e41a222b7a3d5e66084db3cca
      size: 1947
    params:
      data/specs/bert-train-no-empty-answers_experiment.json:
        params.do_eval: true
        params.do_train: true
        params.fp16: true
        params.fp16_opt_level: O1
        params.gradient_accumulation_steps: 8
        params.learning_rate: 5e-05
        params.max_seq_length: 484
        params.meta: bert-train-no-empty-answers
        params.model_type: bert
        params.num_train_epochs: 2
        params.per_device_eval_batch_size: 8
        params.per_device_train_batch_size: 2
        params.task_name: generic
        params.warmup_steps: 500
    outs:
    - path: data/models/bert-train-no-empty-answers/config.json
      md5: fda1d82a923cf7ffd8b9da484296692f
      size: 698
    - path: data/models/bert-train-no-empty-answers/pytorch_model.bin
      md5: 1011835e19507dacaa005790bc1b9789
      size: 437986601
    - path: data/models/bert-train-no-empty-answers/special_tokens_map.json
      md5: 8b3fb1023167bb4ab9d70708eb05f6ec
      size: 112
    - path: data/models/bert-train-no-empty-answers/tokenizer_config.json
      md5: acaa1589c694bf6f6c146b3bac976f67
      size: 161
    - path: data/models/bert-train-no-empty-answers/training_args.bin
      md5: 86e76737c04333939abb0f6eba3e95ff
      size: 1560
    - path: data/models/bert-train-no-empty-answers/vocab.txt
      md5: 64800d5d8528ce344256daf115d4965e
      size: 231508
    - path: data/results/bert-train-no-empty-answers/eval_nbest_predictions.json
      md5: 964986065a498675580b2fabee5bdc66
      size: 351905
    - path: data/results/bert-train-no-empty-answers/eval_predictions.json
      md5: a1f5eeea39df963eda90719dae411888
      size: 34625
    - path: data/results/bert-train-no-empty-answers/train_nbest_predictions.json
      md5: 5037c1e9af7e0f5214944c94952d6324
      size: 1479915
    - path: data/results/bert-train-no-empty-answers/train_predictions.json
      md5: 29950bc197a2dea8e6bfc052666cfee2
      size: 145521
  extract_no_empty_answers_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s train --args_file
      data/specs/bert-eval-no-empty-answers_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2 --oversample 0.5
    deps:
    - path: data/models/bert-train-no-empty-answers
      md5: 1aaf9fd99a1b5c1b368750932fd8ce1a.dir
      size: 438220750
      nfiles: 7
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
    - path: data/specs/bert-eval-no-empty-answers_experiment.json
      md5: 2734e0e160d157c534d86913077b5ed2
      size: 1322
    - path: src/etl/embeddings/extract/extract_embeddings.py
      md5: 375e77b5d8e5727848881bedc5f4d2ea
      size: 15753
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
      md5: 5e9eae97b8b627584b93716b89d760cc.dir
      size: 40571674111
      nfiles: 9096
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings
      md5: f4ccfc1a71538a55d561adba0db1a253.dir
      size: 53953043048
      nfiles: 12096
  extract_no_empty_answers_lengths_oversample_05:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/
      -s train -t generic -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/train.json
      md5: a012eeb6f452195b850f8deb930e4ca5
      size: 2965835
    - path: src/etl/embeddings/extract/extract_lengths.py
      md5: 0233e7c9395d55903d824235618e7a30
      size: 2566
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
      md5: f06fb889b4dfc8d6d32d1b0f50213b5c
      size: 677552
  normalize_no_emtpy_answers_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
      md5: 5e9eae97b8b627584b93716b89d760cc.dir
      size: 40571674111
      nfiles: 9096
    - path: src/etl/embeddings/transform/normalize_embeddings.py
      md5: 4fbd590c4418242cac7712c84a3608bf
      size: 3091
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
      md5: b36ec939b9852c97af9ca94abc5689aa.dir
      size: 6929285
      nfiles: 9096
  extract_no_empty_answers_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/quail_no_empty_answers
      -s train -t generic -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths
    deps:
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
    - path: src/etl/embeddings/extract/extract_lengths.py
      md5: 0233e7c9395d55903d824235618e7a30
      size: 2566
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
      md5: db3c9bb79da844e3815ff2f1d7aa7390
      size: 509608
  merge_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
      md5: b36ec939b9852c97af9ca94abc5689aa.dir
      size: 6929285
      nfiles: 9096
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
      md5: db3c9bb79da844e3815ff2f1d7aa7390
      size: 509608
    - path: src/etl/embeddings/transform/merge_embeddings_and_lengths.py
      md5: bdf8fd8efcebfb7ca4c90b250c44e7b7
      size: 1925
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings_with_lengths
      md5: 37ff2ee09d02ee49e56ca0d5617e341c.dir
      size: 9293985
      nfiles: 9096
  normalize_no_emtpy_answers_embeddings_oversample_05:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/embeddings
      md5: d36c175ce0b3438a2774e462015c12f7.dir
      size: 53950077213
      nfiles: 12095
    - path: src/etl/embeddings/transform/normalize_embeddings.py
      md5: 4fbd590c4418242cac7712c84a3608bf
      size: 3091
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
      md5: 59c486eec8b7489ffde71378c0c87da5.dir
      size: 7400497
      nfiles: 9096
  merge_norm_with_lengths_oversample_05:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
      -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
      md5: 59c486eec8b7489ffde71378c0c87da5.dir
      size: 7400497
      nfiles: 9096
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
      md5: f06fb889b4dfc8d6d32d1b0f50213b5c
      size: 677552
    - path: src/etl/embeddings/transform/merge_embeddings_and_lengths.py
      md5: bdf8fd8efcebfb7ca4c90b250c44e7b7
      size: 1925
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings_with_lengths
      md5: b0b4436eb7dba3acf292c368960e1baf.dir
      size: 9804184
      nfiles: 9096
  classification:
    cmd: python src/etl/embeddings/classify/classification.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2
      -o /data/gblanco/results/quail_no_empty_answers_2 --metrics_dir data/metrics/classification
      --train --eval
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2
      md5: f5c9499401898969427d612afddd7a35.dir
      size: 94559332270
      nfiles: 57578
    - path: src/etl/embeddings/classify/classification.py
      md5: f8e29232bd741b7b5d133086743b6ce2
      size: 10350
    params:
      params.yaml:
        classification:
          iterations: 200
          popsize: 10
          selection: 10
          early_stop: 6
          balanced: false
          memory: 64
          autogoal: false
          pipeline: mlp
          sweep_features: false
          seed: 42
          test_size: 0.2
          metric: weighted_f1
          multi_layer:
            lr: 0.001
            epochs: 100
            batch_size: 200
        features:
          normalization: true
          oversample: false
          embeddings: true
          logits: true
          contexts: true
          question: true
          endings: true
    outs:
    - path: /data/gblanco/results/quail_no_empty_answers_2
      md5: aa8beca8326d683c9978a41c7508106e.dir
      size: 1010084
      nfiles: 2
    - path: data/metrics/classification/scores.json
      md5: 4d62547e3ba4d3caaf96eb6c704e4632
      size: 532
  extract_noea_model_std_quail_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s dev --args_file
      data/specs/bert-eval-noea-std-quail_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/quail_noea_std_2
    deps:
    - path: data/models/bert-train-no-empty-answers
      md5: 1aaf9fd99a1b5c1b368750932fd8ce1a.dir
      size: 438220750
      nfiles: 7
    - path: data/quail_race_fmt/dev.json
      md5: b2573225520d6ae103b7b1f899ebd433
      size: 611156
    - path: data/specs/bert-eval-noea-std-quail_experiment.json
      md5: 63f445ffb89c19c6efd3220ca431979d
      size: 1309
    - path: src/etl/embeddings/extract/extract_embeddings.py
      md5: 375e77b5d8e5727848881bedc5f4d2ea
      size: 15753
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2
      md5: 81c2e6e468208c425d755f083df3a77b.dir
      size: 12870866040
      nfiles: 2165
  extract_noea_model_std_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s dev --args_file
      data/specs/bert-eval-noea-std-quail_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/quail_noea_std_2
    deps:
    - path: data/models/bert-train-no-empty-answers
      md5: 1aaf9fd99a1b5c1b368750932fd8ce1a.dir
      size: 438220750
      nfiles: 7
    - path: data/quail_race_fmt/dev.json
      md5: b2573225520d6ae103b7b1f899ebd433
      size: 611156
    - path: data/specs/bert-eval-noea-std-quail_experiment.json
      md5: 63f445ffb89c19c6efd3220ca431979d
      size: 1309
    - path: src/etl/embeddings/extract/extract_embeddings.py
      md5: 375e77b5d8e5727848881bedc5f4d2ea
      size: 15753
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2/embeddings
      md5: a75ab9b46fe7f10d0c2466f089278de6.dir
      size: 12870866040
      nfiles: 2165
  extract_noea_std_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/quail_race_fmt
      -s dev -t generic -o /data/gblanco/datasets/embeddings/quail_noea_std_2/dev_text_lengths
    deps:
    - path: data/quail_race_fmt/dev.json
      md5: b2573225520d6ae103b7b1f899ebd433
      size: 611156
    - path: src/etl/embeddings/extract/extract_lengths.py
      md5: 0233e7c9395d55903d824235618e7a30
      size: 2566
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2/dev_text_lengths_data.pkl
      md5: 75a33974925a714cd63a056a21092af8
      size: 156087
  normalize_noea_std_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/quail_noea_std_2/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2/embeddings
      md5: a75ab9b46fe7f10d0c2466f089278de6.dir
      size: 12870866040
      nfiles: 2165
    - path: src/etl/embeddings/transform/normalize_embeddings.py
      md5: 4fbd590c4418242cac7712c84a3608bf
      size: 3091
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings
      md5: 961b310f55c4a3330419cb87bf080a4f.dir
      size: 1639207
      nfiles: 2165
  merge_std_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/quail_noea_std_2/dev_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2/dev_text_lengths_data.pkl
      md5: 75a33974925a714cd63a056a21092af8
      size: 156087
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings
      md5: 961b310f55c4a3330419cb87bf080a4f.dir
      size: 1639207
      nfiles: 2165
    - path: src/etl/embeddings/transform/merge_embeddings_and_lengths.py
      md5: bdf8fd8efcebfb7ca4c90b250c44e7b7
      size: 1925
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings_with_lengths
      md5: 2728f00d9e2aa9d144395fef6f93f626.dir
      size: 2236471
      nfiles: 2165
  classifier_corrects_model:
    cmd: python src/etl/embeddings/transform/correct_predictions.py -c /data/gblanco/results/quail_no_empty_answers_2
      -e /data/gblanco/datasets/embeddings/quail_noea_std_2/ -o data/metrics/classifier_corrects_model
      --strategy no_answer --no_answer_text "not enough information" -d data/quail_race_fmt
      -s dev
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_noea_std_2
      md5: 6706f97d202eeef3076faff12824a3d1.dir
      size: 12874897805
      nfiles: 6496
    - path: /data/gblanco/results/quail_no_empty_answers_2
      md5: aa8beca8326d683c9978a41c7508106e.dir
      size: 1010084
      nfiles: 2
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    - path: src/etl/embeddings/transform/correct_predictions.py
      md5: fa1020aff97fc5fb32495d1473ecd059
      size: 9206
    params:
      params.yaml:
        features:
          normalization: true
          oversample: false
          embeddings: true
          logits: true
          contexts: true
          question: true
          endings: true
    outs:
    - path: data/metrics/classifier_corrects_model/eval_nbest_predictions.json
      md5: e325d2a004b0e843d3e355323f235e45
      size: 472118
    - path: data/metrics/classifier_corrects_model/eval_predictions.json
      md5: 482eed5264f8e0cfd366cf5356f541d7
      size: 34625
  evaluate_classifier_corrections:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/metrics/classifier_corrects_model/eval_nbest_predictions.json
      -m C_at_1 avg --task generic -o data/metrics/classifier_corrects_model/corrected_model_results.json
    deps:
    - path: data/metrics/classifier_corrects_model/eval_nbest_predictions.json
      md5: e325d2a004b0e843d3e355323f235e45
      size: 472118
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    outs:
    - path: data/metrics/classifier_corrects_model/corrected_model_results.json
      md5: 4c756a1188989dd77bf2df36e48e1004
      size: 237
  bert-train:
    cmd: ./src/processing/run.sh data/specs/bert-train_experiment.json
    deps:
    - path: data/models/bert-base-uncased
      md5: be46589e12f830a3e7955451e37136ae.dir
      size: 438215920
      nfiles: 5
    - path: data/quail_race_fmt/dev.json
      md5: b2573225520d6ae103b7b1f899ebd433
      size: 611156
    - path: data/quail_race_fmt/train.json
      md5: 6c67d6a9e3c054cf471ef467fbf23e26
      size: 2863957
    - path: src/processing/run.sh
      md5: 311ef43e41a222b7a3d5e66084db3cca
      size: 1947
    params:
      data/specs/bert-train_experiment.json:
        params.do_eval: true
        params.do_train: true
        params.fp16: true
        params.fp16_opt_level: O1
        params.gradient_accumulation_steps: 8
        params.learning_rate: 5e-05
        params.max_seq_length: 484
        params.meta: bert-train
        params.model_type: bert
        params.num_train_epochs: 2
        params.per_device_eval_batch_size: 8
        params.per_device_train_batch_size: 2
        params.task_name: generic
        params.warmup_steps: 500
    outs:
    - path: data/metrics/bert-train/eval_metrics.json
      md5: abb422dd286f01e241c1866ea86c24a2
      size: 66
    - path: data/metrics/bert-train/train_metrics.json
      md5: a628b03a1f87a446a3958b0baa158f60
      size: 66
    - path: data/models/bert-train/config.json
      md5: fda1d82a923cf7ffd8b9da484296692f
      size: 698
    - path: data/models/bert-train/pytorch_model.bin
      md5: 841b29df6dd5540a4a646b07bc513dfd
      size: 437986601
    - path: data/models/bert-train/special_tokens_map.json
      md5: 8b3fb1023167bb4ab9d70708eb05f6ec
      size: 112
    - path: data/models/bert-train/tokenizer_config.json
      md5: acaa1589c694bf6f6c146b3bac976f67
      size: 161
    - path: data/models/bert-train/training_args.bin
      md5: acfe337a328ac9aabaad07c8597cdd59
      size: 1543
    - path: data/models/bert-train/vocab.txt
      md5: 64800d5d8528ce344256daf115d4965e
      size: 231508
    - path: data/results/bert-train/eval_nbest_predictions.json
      md5: a99d0724eda9679b5d08ab42ca41289c
      size: 281119
    - path: data/results/bert-train/eval_predictions.json
      md5: 7c04adacf8e583c8dfad9caf45bb4b1f
      size: 34625
    - path: data/results/bert-train/train_nbest_predictions.json
      md5: fdfbd5cf5a40c82ab8b61554dff8e215
      size: 1333768
    - path: data/results/bert-train/train_predictions.json
      md5: 4b01739e92ca8a93f7797b0b44700afa
      size: 163937
  bert-eval-noea-std-quail:
    cmd: ./src/processing/run.sh data/specs/bert-eval-noea-std-quail_experiment.json
    deps:
    - path: data/models/bert-train-no-empty-answers
      md5: 1aaf9fd99a1b5c1b368750932fd8ce1a.dir
      size: 438220750
      nfiles: 7
    - path: data/quail_race_fmt/dev.json
      md5: b2573225520d6ae103b7b1f899ebd433
      size: 611156
    - path: src/processing/run.sh
      md5: 311ef43e41a222b7a3d5e66084db3cca
      size: 1947
    params:
      data/specs/bert-eval-noea-std-quail_experiment.json:
        params.do_eval: true
        params.do_train: false
        params.fp16: true
        params.fp16_opt_level: O1
        params.gradient_accumulation_steps: 8
        params.learning_rate: 5e-05
        params.max_seq_length: 484
        params.meta: bert-eval-noea-std-quail
        params.model_type: bert
        params.num_train_epochs: 2
        params.per_device_eval_batch_size: 8
        params.per_device_train_batch_size: 2
        params.task_name: generic
        params.warmup_steps: 500
    outs:
    - path: data/metrics/bert-eval-noea-std-quail/eval_metrics.json
      md5: 3663b276f0dff5d6746facdb58f31f52
      size: 64
    - path: data/results/bert-eval-noea-std-quail/eval_nbest_predictions.json
      md5: 3254f01a68bd34bda606ee32cf09cb16
      size: 423108
    - path: data/results/bert-eval-noea-std-quail/eval_predictions.json
      md5: 09da4257784d1c73546e61db60f520cb
      size: 34625
  evaluate_bert:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/results/bert-train/eval_nbest_predictions.json
      -m C_at_1 avg --task generic -o data/metrics/bert-train/eval_mcqa.json
    deps:
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    - path: data/results/bert-train/eval_nbest_predictions.json
      md5: a99d0724eda9679b5d08ab42ca41289c
      size: 281119
    outs:
    - path: data/metrics/bert-train/eval_mcqa.json
      md5: 453ac4446acfccb2a52784161c6aca52
      size: 235
  evaluate_bert_noea_std_quail:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/results/bert-eval-noea-std-quail/eval_nbest_predictions.json
      -m C_at_1 avg --task generic -o data/metrics/bert-eval-noea-std-quail/eval_mcqa.json
    deps:
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    - path: data/results/bert-eval-noea-std-quail/eval_nbest_predictions.json
      md5: 3254f01a68bd34bda606ee32cf09cb16
      size: 423108
    outs:
    - path: data/metrics/bert-eval-noea-std-quail/eval_mcqa.json
      md5: aa226020c50c79708eb3ca6c816524ff
      size: 235
  dl_race:
    cmd: ./src/etl/dl_race.sh
    deps:
    - path: src/etl/dl_race.sh
      md5: 66aa5212d0687e98ca1c0b6e6ee8d5ec
      size: 180
    outs:
    - path: data/RACE/dev
      md5: 1be4be7086bef61408432e677c5056d0.dir
      size: 3308878
      nfiles: 1389
    - path: data/RACE/test
      md5: d04fc25fbac6952abca0d72aa7a7a45e.dir
      size: 3368243
      nfiles: 1407
    - path: data/RACE/train
      md5: 487f0c637a5872e97716f6714a430585.dir
      size: 60493414
      nfiles: 25137
  tr_quail_dev_no_empty_answers_removed:
    cmd: python src/etl/choices/reformat_dataset.py -d ./data/quail_race_fmt -o ./data/quail_empty_answers_removed
      -s dev --no_answer_text "not enough information"
    deps:
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    - path: src/etl/choices/reformat_dataset.py
      md5: e8e3c8d3f5afcfc5c8c9fda62296ac7d
      size: 4721
    outs:
    - path: data/quail_empty_answers_removed/dev.json
      md5: e8c4ed4ea82859767ebbdd4bcec51d3f
      size: 524048
  tr_quail_train_no_empty_answers_removed:
    cmd: python src/etl/choices/reformat_dataset.py -d ./data/quail_race_fmt -o ./data/quail_empty_answers_removed
      -s train --no_answer_text "not enough information"
    deps:
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    - path: src/etl/choices/reformat_dataset.py
      md5: e8e3c8d3f5afcfc5c8c9fda62296ac7d
      size: 4721
    outs:
    - path: data/quail_empty_answers_removed/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
  bert-train-race:
    cmd: ./src/processing/run.sh data/specs/bert-train-race_experiment.json
    deps:
    - path: data/RACE/dev
      md5: 1be4be7086bef61408432e677c5056d0.dir
      size: 3308878
      nfiles: 1389
    - path: data/RACE/train
      md5: 487f0c637a5872e97716f6714a430585.dir
      size: 60493414
      nfiles: 25137
    - path: data/models/bert-base-uncased
      md5: be46589e12f830a3e7955451e37136ae.dir
      size: 438215920
      nfiles: 5
    - path: src/processing/run.sh
      md5: 311ef43e41a222b7a3d5e66084db3cca
      size: 1947
    params:
      data/specs/bert-train-race_experiment.json:
        params.do_eval: true
        params.do_train: true
        params.fp16: true
        params.fp16_opt_level: O1
        params.gradient_accumulation_steps: 8
        params.learning_rate: 5e-05
        params.max_seq_length: 484
        params.meta: bert-train-race
        params.model_type: bert
        params.num_train_epochs: 2
        params.per_device_eval_batch_size: 8
        params.per_device_train_batch_size: 2
        params.task_name: race
        params.warmup_steps: 500
    outs:
    - path: data/RACE/cached_dev_BertTokenizer_484_race
      md5: e57536c12df493892bca0cad6ef25921
      size: 64271410
    - path: data/RACE/cached_dev_BertTokenizer_484_race.lock
      md5: d41d8cd98f00b204e9800998ecf8427e
      size: 0
      isexec: true
    - path: data/metrics/bert-train-race/eval_metrics.json
      md5: 43e34ea9863968b48328465803bd1679
      size: 66
    - path: data/metrics/bert-train-race/train_metrics.json
      md5: a05651c62ec4bff6b0a1f7895cdffa8b
      size: 67
    - path: data/models/bert-train-race/config.json
      md5: 56e07662d4cb143aeb5ce3c5c9c2a992
      size: 695
    - path: data/models/bert-train-race/pytorch_model.bin
      md5: f424c623dd7bdccb7fce5215977b9dba
      size: 437986601
    - path: data/models/bert-train-race/special_tokens_map.json
      md5: 8b3fb1023167bb4ab9d70708eb05f6ec
      size: 112
    - path: data/models/bert-train-race/tokenizer_config.json
      md5: acaa1589c694bf6f6c146b3bac976f67
      size: 161
    - path: data/models/bert-train-race/training_args.bin
      md5: d8a1ec0cbb0886eb975b9f24f646a180
      size: 1548
    - path: data/models/bert-train-race/vocab.txt
      md5: 64800d5d8528ce344256daf115d4965e
      size: 231508
    - path: data/results/bert-train-race/eval_nbest_predictions.json
      md5: 8105df24e0b18f69364d28f791a69434
      size: 671629
    - path: data/results/bert-train-race/eval_predictions.json
      md5: 244343379c58a74108400a2000803bb4
      size: 146253
    - path: data/results/bert-train-race/train_nbest_predictions.json
      md5: 563ab1462db8c22709ea630fd8a36585
      size: 12181319
    - path: data/results/bert-train-race/train_predictions.json
      md5: 2266fa0b8364c98e150bc70d02266f61
      size: 2805048
  bert-eval-noea-mod-quail:
    cmd: ./src/processing/run.sh data/specs/bert-eval-noea-mod-quail_experiment.json
    deps:
    - path: data/models/bert-train-no-empty-answers
      md5: 1aaf9fd99a1b5c1b368750932fd8ce1a.dir
      size: 438220750
      nfiles: 7
    - path: data/quail_empty_answers_removed/dev.json
      md5: e8c4ed4ea82859767ebbdd4bcec51d3f
      size: 524048
    - path: data/quail_empty_answers_removed/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
    - path: src/processing/run.sh
      md5: 311ef43e41a222b7a3d5e66084db3cca
      size: 1947
    params:
      data/specs/bert-eval-noea-mod-quail_experiment.json:
        params.do_eval: true
        params.do_train: false
        params.fp16: true
        params.fp16_opt_level: O1
        params.gradient_accumulation_steps: 8
        params.learning_rate: 5e-05
        params.max_seq_length: 484
        params.meta: bert-eval-noea-mod-quail
        params.model_type: bert
        params.num_train_epochs: 2
        params.per_device_eval_batch_size: 8
        params.per_device_train_batch_size: 2
        params.task_name: generic
        params.warmup_steps: 500
    outs:
    - path: data/metrics/bert-eval-noea-mod-quail/eval_metrics.json
      md5: bc7d0c19856e290f1885e64f6bdfca19
      size: 65
    - path: data/models/bert-eval-noea-mod-quail/config.json
      md5: fda1d82a923cf7ffd8b9da484296692f
      size: 698
    - path: data/models/bert-eval-noea-mod-quail/pytorch_model.bin
      md5: f58daea11b60f5587a51a12f9aa816db
      size: 437986601
    - path: data/models/bert-eval-noea-mod-quail/special_tokens_map.json
      md5: 8b3fb1023167bb4ab9d70708eb05f6ec
      size: 112
    - path: data/models/bert-eval-noea-mod-quail/tokenizer_config.json
      md5: acaa1589c694bf6f6c146b3bac976f67
      size: 161
    - path: data/models/bert-eval-noea-mod-quail/training_args.bin
      md5: 389ca820235348da4ae8bd1fc8d84aad
      size: 1557
    - path: data/models/bert-eval-noea-mod-quail/vocab.txt
      md5: 64800d5d8528ce344256daf115d4965e
      size: 231508
    - path: data/results/bert-eval-noea-mod-quail/eval_nbest_predictions.json
      md5: f1811d03114715b8442746b7c7f932ae
      size: 308405
    - path: data/results/bert-eval-noea-mod-quail/eval_predictions.json
      md5: e08236ba0426277a5193e335f7e3c271
      size: 30785
  evaluate_bert_race:
    cmd: mcqa_utils -d data/RACE -n data/results/bert-train-race/eval_nbest_predictions.json
      -m C_at_1 avg --task race -o data/metrics/bert-train-race/eval_mcqa.json
    deps:
    - path: data/RACE/dev/
      md5: 1be4be7086bef61408432e677c5056d0.dir
      size: 3308878
      nfiles: 1389
    - path: data/results/bert-train-race/eval_nbest_predictions.json
      md5: 8105df24e0b18f69364d28f791a69434
      size: 671629
    outs:
    - path: data/metrics/bert-train-race/eval_mcqa.json
      md5: 0ff7967b24a50552599a6cb15d626e86
      size: 237
  evaluate_bert_noea_mod_quail:
    cmd: mcqa_utils -d data/quail_empty_answers_removed -n data/results/bert-eval-noea-mod-quail/eval_nbest_predictions.json
      -m C_at_1 avg --task generic -o data/metrics/bert-eval-noea-mod-quail/eval_mcqa.json
    deps:
    - path: data/quail_empty_answers_removed
      md5: 3b7e8fc7d5b42564c33bc1cde563d7e5.dir
      size: 114670094
      nfiles: 7
    - path: data/results/bert-eval-noea-mod-quail/eval_nbest_predictions.json
      md5: f1811d03114715b8442746b7c7f932ae
      size: 308405
    outs:
    - path: data/metrics/bert-eval-noea-mod-quail/eval_mcqa.json
      md5: 099e3dcdfce1ef863ad2159ceb2600ba
      size: 235
  extract_std_race_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s train --args_file
      data/specs/bert-eval-race_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/std_race
    deps:
    - path: data/models/bert-train-race
      md5: 26b1298631f3d827c5fcf263bfda5d50.dir
      size: 438220735
      nfiles: 7
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
    - path: data/specs/bert-eval-race_experiment.json
      md5: 4f59c9c4c4e6b316f8fb45240f95c8a8
      size: 1202
    - path: src/etl/embeddings/extract/extract_embeddings.py
      md5: 375e77b5d8e5727848881bedc5f4d2ea
      size: 15753
    outs:
    - path: /data/gblanco/datasets/embeddings/std_race/embeddings
      md5: fb5e05220c47021d58924b7ef5d0bd19.dir
      size: 522590008556
      nfiles: 87865
  extract_std_race_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/RACE -s train
      -t race -o /data/gblanco/datasets/embeddings/std_race/train_text_lengths
    deps:
    - path: data/RACE/train
      md5: 487f0c637a5872e97716f6714a430585.dir
      size: 60493414
      nfiles: 25137
    - path: src/etl/embeddings/extract/extract_lengths.py
      md5: 0233e7c9395d55903d824235618e7a30
      size: 2566
    outs:
    - path: /data/gblanco/datasets/embeddings/std_race/train_text_lengths_data.pkl
      md5: aa1ba36b94b41ffa48da1d8b7e559cd7
      size: 6326502
  normalize_std_race_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/std_race/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/std_race/normalized_embeddings
    deps:
    - path: /data/gblanco/datasets/embeddings/std_race/embeddings
      md5: fb5e05220c47021d58924b7ef5d0bd19.dir
      size: 522590008556
      nfiles: 87865
    - path: src/etl/embeddings/transform/normalize_embeddings.py
      md5: 4fbd590c4418242cac7712c84a3608bf
      size: 3091
    outs:
    - path: /data/gblanco/datasets/embeddings/std_race/normalized_embeddings
      md5: 86dcd066732ae861212fb2a5c3aa5608.dir
      size: 65974759
      nfiles: 87865
  merge_std_race_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/std_race/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/std_race/train_text_lengths_data.pkl -o
      /data/gblanco/datasets/embeddings/std_race/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - path: /data/gblanco/datasets/embeddings/std_race/normalized_embeddings
      md5: 86dcd066732ae861212fb2a5c3aa5608.dir
      size: 65974759
      nfiles: 87865
    - path: /data/gblanco/datasets/embeddings/std_race/train_text_lengths_data.pkl
      md5: aa1ba36b94b41ffa48da1d8b7e559cd7
      size: 6326502
    - path: src/etl/embeddings/transform/merge_embeddings_and_lengths.py
      md5: bdf8fd8efcebfb7ca4c90b250c44e7b7
      size: 1925
    outs:
    - path: /data/gblanco/datasets/embeddings/std_race/normalized_embeddings_with_lengths
      md5: 91b10b01eb4994c3807a1b7ba0e71cd1.dir
      size: 90225223
      nfiles: 87865
  classification_std_race:
    cmd: python src/etl/embeddings/classify/classification.py -d /data/gblanco/datasets/embeddings/std_race
      -o /data/gblanco/results/std_race --metrics_dir data/metrics/classification_std_race
      --train --eval
    deps:
    - path: /data/gblanco/datasets/embeddings/std_race
      md5: fe7d01d3903c5a9a5d8b434bb0741922.dir
      size: 522752535040
      nfiles: 263596
    - path: src/etl/embeddings/classify/classification.py
      md5: f8e29232bd741b7b5d133086743b6ce2
      size: 10350
    params:
      params.yaml:
        classification:
          iterations: 200
          popsize: 10
          selection: 10
          early_stop: 6
          balanced: false
          memory: 64
          autogoal: false
          pipeline: logreg
          sweep_features: false
          seed: 42
          test_size: 0.2
          metric: weighted_f1
          multi_layer:
            lr: 0.001
            epochs: 100
            batch_size: 200
        features:
          normalization: true
          oversample: false
          embeddings: true
          logits: false
          contexts: false
          question: true
          endings: true
    outs:
    - path: /data/gblanco/results/std_race
      md5: c9332d3079a8bbc76bca8faaa91026c8.dir
      size: 6628
      nfiles: 3
    - path: data/metrics/classification_std_race/scores.json
      md5: 8ad34d78f2b9365bc45855cffd97910f
      size: 517
  classifier_corrects_std_race_model:
    cmd: python src/etl/embeddings/transform/correct_predictions.py -c /data/gblanco/results/std_race
      -e /data/gblanco/datasets/embeddings/std_race/ -o data/metrics/classifier_corrects_std_race_model
      --strategy empty_answer -d data/RACE --task race -s dev
    deps:
    - path: /data/gblanco/datasets/embeddings/std_race
      md5: fe7d01d3903c5a9a5d8b434bb0741922.dir
      size: 522752535040
      nfiles: 263596
    - path: /data/gblanco/results/std_race
      md5: c9332d3079a8bbc76bca8faaa91026c8.dir
      size: 6628
      nfiles: 3
    - path: data/RACE
      md5: 7c501bc79b1c1b2f9e16bf5535ed7cb7.dir
      size: 1287967500
      nfiles: 27937
    - path: src/etl/embeddings/transform/correct_predictions.py
      md5: fa1020aff97fc5fb32495d1473ecd059
      size: 9206
    params:
      params.yaml:
        features:
          normalization: true
          oversample: false
          embeddings: true
          logits: false
          contexts: false
          question: true
          endings: true
    outs:
    - path: data/metrics/classifier_corrects_std_race_model/eval_nbest_predictions.json
      md5: d470f8ef6875ca92260d1ecbaaea9aaa
      size: 1128986
    - path: data/metrics/classifier_corrects_std_race_model/eval_predictions.json
      md5: 869a5f2d5a2fec7e797a7c86a91641f4
      size: 146253
  evaluate_classifier_corrections_std_race_model:
    cmd: mcqa_utils -d data/RACE -n data/metrics/classifier_corrects_std_race_model/eval_nbest_predictions.json
      -m C_at_1 avg --task race -o data/metrics/classifier_corrects_std_race_model/corrected_model_results.json
    deps:
    - path: data/metrics/classifier_corrects_std_race_model/eval_nbest_predictions.json
      md5: d470f8ef6875ca92260d1ecbaaea9aaa
      size: 1128986
    - path: data/quail_race_fmt
      md5: e965782a0bf94efb8fbe0eaab74aefbd.dir
      size: 170911082
      nfiles: 7
    outs:
    - path: data/metrics/classifier_corrects_std_race_model/corrected_model_results.json
      md5: 2c33228c4165dbe7d4c8faaaad251ffa
      size: 239
