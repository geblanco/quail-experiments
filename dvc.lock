schema: '2.0'
stages:
  dl_quail:
    cmd: ./src/etl/dl_quail.sh
    deps:
    - path: src/etl/dl_quail.sh
      md5: 35c895bd0b066481c8f7fba6dd57a0cb
      size: 824
    outs:
    - path: data/quail/dev.json
      md5: 710c954716143d6d3c8c2ef2044f5c0c
      size: 955449
    - path: data/quail/dev_answers.json
      md5: 1665e633ee7aa0183a45a3749e4e061b
      size: 46710
    - path: data/quail/eval.py
      md5: cab53a1ed0c7248b036be788fa60ec3c
      size: 1446
    - path: data/quail/train.json
      md5: 5409940d9b8479dc51fe56c9b5607344
      size: 4498702
    - path: data/quail/train_answers.json
      md5: c1b17d1e9bb8bbce4b28c253e5167001
      size: 199358
  tr_quail_dev_to_race:
    cmd: src/etl/preprocess_quail_to_race.py data/quail/dev.json data/quail/dev_answers.json
      -o data/quail_race_fmt/dev.json
    deps:
    - path: data/quail/dev.json
      md5: 710c954716143d6d3c8c2ef2044f5c0c
      size: 955449
    - path: data/quail/dev_answers.json
      md5: 1665e633ee7aa0183a45a3749e4e061b
      size: 46710
    - path: src/etl/preprocess_quail_to_race.py
      md5: d85a3aa72f907adfdef52155b94d55b5
      size: 3261
    outs:
    - path: data/quail_race_fmt/dev.json
      md5: b2573225520d6ae103b7b1f899ebd433
      size: 611156
  tr_quail_train_to_race:
    cmd: src/etl/preprocess_quail_to_race.py data/quail/train.json data/quail/train_answers.json
      -o data/quail_race_fmt/train.json
    deps:
    - path: data/quail/train.json
      md5: 5409940d9b8479dc51fe56c9b5607344
      size: 4498702
    - path: data/quail/train_answers.json
      md5: c1b17d1e9bb8bbce4b28c253e5167001
      size: 199358
    - path: src/etl/preprocess_quail_to_race.py
      md5: d85a3aa72f907adfdef52155b94d55b5
      size: 3261
    outs:
    - path: data/quail_race_fmt/train.json
      md5: 6c67d6a9e3c054cf471ef467fbf23e26
      size: 2863957
  tr_quail_dev_no_empty_answers:
    cmd: python src/etl/choices/reformat_dataset.py -d ./data/quail_race_fmt -o ./data/quail_no_empty_answers
      -s dev --no_answer_text "not enough information" --keep_matching_text --index_list_path
      ./data/quail_no_empty_answers/dev_index_list.json
    deps:
    - path: data/quail_race_fmt
      md5: a285061c0fce5446207646fcddcecfeb.dir
      size: 3475135
      nfiles: 3
    - path: src/etl/choices/reformat_dataset.py
      md5: e8e3c8d3f5afcfc5c8c9fda62296ac7d
      size: 4721
    outs:
    - path: ./data/quail_no_empty_answers/dev_index_list.json
      md5: df9910f3a043308666bffbeb9fcebe5e
      size: 30297
    - path: data/quail_no_empty_answers/dev.json
      md5: 0527f4f70f20380b3eb7b506c063a7d8
      size: 554890
  tr_quail_train_no_empty_answers:
    cmd: python src/etl/choices/reformat_dataset.py -d data/quail_race_fmt -o data/quail_no_empty_answers
      -s train --no_answer_text "not enough information"
    deps:
    - path: data/quail_race_fmt
      md5: a285061c0fce5446207646fcddcecfeb.dir
      size: 3475135
      nfiles: 3
    - path: src/etl/choices/reformat_dataset.py
      md5: e8e3c8d3f5afcfc5c8c9fda62296ac7d
      size: 4721
    outs:
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
  dl_models:
    cmd: python ./src/etl/dl_models.py -m bert-base-uncased --overwrite
    deps:
    - path: src/etl/dl_models.py
      md5: c2ca665ea793afe968fff649f0e04717
      size: 2452
    outs:
    - path: data/models/bert-base-uncased
      md5: be46589e12f830a3e7955451e37136ae.dir
      size: 438215920
      nfiles: 5
  bert-train-no-empty-answers:
    cmd: ./src/processing/run.sh data/specs/bert-train-no-empty-answers_experiment.json
    deps:
    - path: data/models/bert-base-uncased
      md5: be46589e12f830a3e7955451e37136ae.dir
      size: 438215920
      nfiles: 5
    - path: data/quail_no_empty_answers/dev.json
      md5: 0527f4f70f20380b3eb7b506c063a7d8
      size: 554890
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
    - path: src/processing/run.sh
      md5: 311ef43e41a222b7a3d5e66084db3cca
      size: 1947
    params:
      data/specs/bert-train-no-empty-answers_experiment.json:
        params.do_eval: true
        params.do_train: true
        params.fp16: true
        params.fp16_opt_level: O1
        params.gradient_accumulation_steps: 8
        params.learning_rate: 5e-05
        params.max_seq_length: 484
        params.meta: bert-train-no-empty-answers
        params.model_type: bert
        params.num_train_epochs: 2
        params.per_device_eval_batch_size: 8
        params.per_device_train_batch_size: 2
        params.task_name: generic
        params.warmup_steps: 500
    outs:
    - path: data/metrics/bert-train-no-empty-answers/eval_metrics.json
      md5: 5a4f1683f08baecd85ab2ea48726ea8a
      size: 66
    - path: data/metrics/bert-train-no-empty-answers/train_metrics.json
      md5: eeff26dc790409cc63d884251979714f
      size: 66
    - path: data/models/bert-train-no-empty-answers/config.json
      md5: fda1d82a923cf7ffd8b9da484296692f
      size: 698
    - path: data/models/bert-train-no-empty-answers/pytorch_model.bin
      md5: 1011835e19507dacaa005790bc1b9789
      size: 437986601
    - path: data/models/bert-train-no-empty-answers/special_tokens_map.json
      md5: 8b3fb1023167bb4ab9d70708eb05f6ec
      size: 112
    - path: data/models/bert-train-no-empty-answers/tokenizer_config.json
      md5: acaa1589c694bf6f6c146b3bac976f67
      size: 161
    - path: data/models/bert-train-no-empty-answers/training_args.bin
      md5: 86e76737c04333939abb0f6eba3e95ff
      size: 1560
    - path: data/models/bert-train-no-empty-answers/vocab.txt
      md5: 64800d5d8528ce344256daf115d4965e
      size: 231508
    - path: data/results/bert-train-no-empty-answers/eval_nbest_predictions.json
      md5: 964986065a498675580b2fabee5bdc66
      size: 351905
    - path: data/results/bert-train-no-empty-answers/eval_predictions.json
      md5: a1f5eeea39df963eda90719dae411888
      size: 34625
    - path: data/results/bert-train-no-empty-answers/train_nbest_predictions.json
      md5: 5037c1e9af7e0f5214944c94952d6324
      size: 1479915
    - path: data/results/bert-train-no-empty-answers/train_predictions.json
      md5: 29950bc197a2dea8e6bfc052666cfee2
      size: 145521
  extract_no_empty_answers_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s train --args_file
      data/specs/bert-eval-no-empty-answers_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2 --oversample 0.5
    deps:
    - path: data/models/bert-train-no-empty-answers
      md5: 1aaf9fd99a1b5c1b368750932fd8ce1a.dir
      size: 438220750
      nfiles: 7
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
    - path: data/specs/bert-eval-no-empty-answers_experiment.json
      md5: 2734e0e160d157c534d86913077b5ed2
      size: 1322
    - path: src/etl/embeddings/extract/extract_embeddings.py
      md5: 375e77b5d8e5727848881bedc5f4d2ea
      size: 15753
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
      md5: 5e9eae97b8b627584b93716b89d760cc.dir
      size: 40571674111
      nfiles: 9096
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings
      md5: f4ccfc1a71538a55d561adba0db1a253.dir
      size: 53953043048
      nfiles: 12096
  extract_no_empty_answers_lengths_oversample_05:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/
      -s train -t generic -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/train.json
      md5: a012eeb6f452195b850f8deb930e4ca5
      size: 2965835
    - path: src/etl/embeddings/extract/extract_lengths.py
      md5: 1947b907bf19b546e09ac5a00fde7230
      size: 2559
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
      md5: f06fb889b4dfc8d6d32d1b0f50213b5c
      size: 677552
  normalize_no_emtpy_answers_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
      md5: 5e9eae97b8b627584b93716b89d760cc.dir
      size: 40571674111
      nfiles: 9096
    - path: src/etl/embeddings/transform/normalize_embeddings.py
      md5: 4fbd590c4418242cac7712c84a3608bf
      size: 3091
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
      md5: b36ec939b9852c97af9ca94abc5689aa.dir
      size: 6929285
      nfiles: 9096
  extract_no_empty_answers_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/quail_no_empty_answers
      -s train -t generic -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths
    deps:
    - path: data/quail_no_empty_answers/train.json
      md5: d3a6f28fa96f7431cee0ec4aa4193105
      size: 2451755
    - path: src/etl/embeddings/extract/extract_lengths.py
      md5: 1947b907bf19b546e09ac5a00fde7230
      size: 2559
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
      md5: db3c9bb79da844e3815ff2f1d7aa7390
      size: 509608
  merge_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
      md5: b36ec939b9852c97af9ca94abc5689aa.dir
      size: 6929285
      nfiles: 9096
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
      md5: db3c9bb79da844e3815ff2f1d7aa7390
      size: 509608
    - path: src/etl/embeddings/transform/merge_embeddings_and_lengths.py
      md5: bdf8fd8efcebfb7ca4c90b250c44e7b7
      size: 1925
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings_with_lengths
      md5: 37ff2ee09d02ee49e56ca0d5617e341c.dir
      size: 9293985
      nfiles: 9096
  normalize_no_emtpy_answers_embeddings_oversample_05:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/embeddings
      md5: d36c175ce0b3438a2774e462015c12f7.dir
      size: 53950077213
      nfiles: 12095
    - path: src/etl/embeddings/transform/normalize_embeddings.py
      md5: 4fbd590c4418242cac7712c84a3608bf
      size: 3091
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
      md5: 59c486eec8b7489ffde71378c0c87da5.dir
      size: 7400497
      nfiles: 9096
  merge_norm_with_lengths_oversample_05:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
      -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
      md5: 59c486eec8b7489ffde71378c0c87da5.dir
      size: 7400497
      nfiles: 9096
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
      md5: f06fb889b4dfc8d6d32d1b0f50213b5c
      size: 677552
    - path: src/etl/embeddings/transform/merge_embeddings_and_lengths.py
      md5: bdf8fd8efcebfb7ca4c90b250c44e7b7
      size: 1925
    outs:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings_with_lengths
      md5: b0b4436eb7dba3acf292c368960e1baf.dir
      size: 9804184
      nfiles: 9096
  classification:
    cmd: python src/etl/embeddings/classify/classification.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2
      -o /data/gblanco/results/quail_no_empty_answers_2 --metrics_dir data/metrics/classification
      --train --eval
    deps:
    - path: /data/gblanco/datasets/embeddings/quail_no_empty_answers_2
      md5: f5c9499401898969427d612afddd7a35.dir
      size: 94559332270
      nfiles: 57578
    - path: src/etl/embeddings/classify/classification.py
      md5: d1245f59ec37be29a381fa48022ab708
      size: 10029
    params:
      params.yaml:
        classification:
          iterations: 200
          popsize: 50
          selection: 10
          early_stop: 6
          balanced: false
          memory: 64
          autogoal: false
          pipeline: mlp
          sweep_features: false
          seed: 42
          test_size: 0.2
          metric: weighted_f1
          multi_layer:
            lr: 0.001
            epochs: 100
            batch_size: 200
        features:
          normalization: true
          oversample: true
          text_length: true
          embeddings: true
          logits: false
          context: false
          question: false
          endings: true
    outs:
    - path: /data/gblanco/results/quail_no_empty_answers_2
      md5: 110f9ca96afa981be807634c95c31f31.dir
      size: 1010084
      nfiles: 2
    - path: data/metrics/classification/scores.json
      md5: 0a183ece9016f097d44f4f5a9abceb88
      size: 530
