stages:
  dl_quail:
    cmd: ./src/etl/dl_quail.sh
    deps:
    - src/etl/dl_quail.sh
    outs:
    - data/quail/dev.json
    - data/quail/dev_answers.json
    - data/quail/eval.py
    - data/quail/train.json
    - data/quail/train_answers.json
  dl_models:
    cmd: python ./src/etl/dl_models.py -m bert-base-uncased --overwrite
    deps:
    - src/etl/dl_models.py
    outs:
    - data/models/bert-base-uncased
  dl_race:
    cmd: ./src/etl/dl_race.sh
    deps:
    - src/etl/dl_race.sh
    outs:
    - data/RACE/train
    - data/RACE/dev
    - data/RACE/test
  tr_quail_train_to_race:
    cmd: src/etl/preprocess_quail_to_race.py data/quail/train.json data/quail/train_answers.json
      -o data/quail_race_fmt/train.json
    deps:
    - data/quail/train.json
    - data/quail/train_answers.json
    - src/etl/preprocess_quail_to_race.py
    outs:
    - data/quail_race_fmt/train.json
  tr_quail_dev_to_race:
    cmd: src/etl/preprocess_quail_to_race.py data/quail/dev.json data/quail/dev_answers.json
      -o data/quail_race_fmt/dev.json
    deps:
    - data/quail/dev.json
    - data/quail/dev_answers.json
    - src/etl/preprocess_quail_to_race.py
    outs:
    - data/quail_race_fmt/dev.json
  tr_quail_train_no_empty_answers:
    cmd: python src/etl/choices/reformat_dataset.py -d data/quail_race_fmt -o data/quail_no_empty_answers
      -s train --no_answer_text "not enough information"
    deps:
    - data/quail_race_fmt
    - src/etl/choices/reformat_dataset.py
    outs:
    - data/quail_no_empty_answers/train.json
  tr_quail_dev_no_empty_answers:
    cmd: python src/etl/choices/reformat_dataset.py -d ./data/quail_race_fmt -o ./data/quail_no_empty_answers
      -s dev --no_answer_text "not enough information" --keep_matching_text --index_list_path
      ./data/quail_no_empty_answers/dev_index_list.json
    deps:
    - data/quail_race_fmt
    - src/etl/choices/reformat_dataset.py
    outs:
    - ./data/quail_no_empty_answers/dev_index_list.json
    - data/quail_no_empty_answers/dev.json
  tr_quail_dev_no_empty_answers_removed:
    cmd: python src/etl/choices/reformat_dataset.py -d ./data/quail_race_fmt -o ./data/quail_empty_answers_removed
      -s dev --no_answer_text "not enough information"
    deps:
    - data/quail_race_fmt
    - src/etl/choices/reformat_dataset.py
    outs:
    - data/quail_empty_answers_removed/dev.json
  tr_quail_train_no_empty_answers_removed:
    cmd: python src/etl/choices/reformat_dataset.py -d ./data/quail_race_fmt -o ./data/quail_empty_answers_removed
      -s train --no_answer_text "not enough information"
    deps:
    - data/quail_race_fmt
    - src/etl/choices/reformat_dataset.py
    outs:
    - data/quail_empty_answers_removed/train.json
  bert-train:
    cmd: ./src/processing/run.sh data/specs/bert-train_experiment.json
    deps:
    - data/models/bert-base-uncased
    - data/quail_race_fmt/dev.json
    - data/quail_race_fmt/train.json
    - src/processing/run.sh
    params:
    - data/specs/bert-train_experiment.json:
      - params.do_eval
      - params.do_train
      - params.fp16
      - params.fp16_opt_level
      - params.gradient_accumulation_steps
      - params.learning_rate
      - params.max_seq_length
      - params.meta
      - params.model_type
      - params.num_train_epochs
      - params.per_device_eval_batch_size
      - params.per_device_train_batch_size
      - params.task_name
      - params.warmup_steps
    outs:
    - data/models/bert-train/config.json
    - data/models/bert-train/pytorch_model.bin
    - data/models/bert-train/special_tokens_map.json
    - data/models/bert-train/tokenizer_config.json
    - data/models/bert-train/training_args.bin
    - data/models/bert-train/vocab.txt
    - data/results/bert-train/eval_nbest_predictions.json
    - data/results/bert-train/eval_predictions.json
    - data/results/bert-train/train_nbest_predictions.json
    - data/results/bert-train/train_predictions.json
    metrics:
    - data/metrics/bert-train/eval_metrics.json
    - data/metrics/bert-train/train_metrics.json
  bert-train-no-empty-answers:
    cmd: ./src/processing/run.sh data/specs/bert-train-no-empty-answers_experiment.json
    deps:
    - data/models/bert-base-uncased
    - data/quail_no_empty_answers/dev.json
    - data/quail_no_empty_answers/train.json
    - src/processing/run.sh
    params:
    - data/specs/bert-train-no-empty-answers_experiment.json:
      - params.do_eval
      - params.do_train
      - params.fp16
      - params.fp16_opt_level
      - params.gradient_accumulation_steps
      - params.learning_rate
      - params.max_seq_length
      - params.meta
      - params.model_type
      - params.num_train_epochs
      - params.per_device_eval_batch_size
      - params.per_device_train_batch_size
      - params.task_name
      - params.warmup_steps
    outs:
    - data/models/bert-train-no-empty-answers/config.json
    - data/models/bert-train-no-empty-answers/pytorch_model.bin
    - data/models/bert-train-no-empty-answers/special_tokens_map.json
    - data/models/bert-train-no-empty-answers/tokenizer_config.json
    - data/models/bert-train-no-empty-answers/training_args.bin
    - data/models/bert-train-no-empty-answers/vocab.txt
    - data/results/bert-train-no-empty-answers/eval_nbest_predictions.json
    - data/results/bert-train-no-empty-answers/eval_predictions.json
    - data/results/bert-train-no-empty-answers/train_nbest_predictions.json
    - data/results/bert-train-no-empty-answers/train_predictions.json
  bert-eval-noea-std-quail:
    cmd: ./src/processing/run.sh data/specs/bert-eval-noea-std-quail_experiment.json
    deps:
    - data/models/bert-train-no-empty-answers
    - data/quail_race_fmt/dev.json
    - src/processing/run.sh
    params:
    - data/specs/bert-eval-noea-std-quail_experiment.json:
      - params.do_eval
      - params.do_train
      - params.fp16
      - params.fp16_opt_level
      - params.gradient_accumulation_steps
      - params.learning_rate
      - params.max_seq_length
      - params.meta
      - params.model_type
      - params.num_train_epochs
      - params.per_device_eval_batch_size
      - params.per_device_train_batch_size
      - params.task_name
      - params.warmup_steps
    outs:
    - data/results/bert-eval-noea-std-quail/eval_nbest_predictions.json
    - data/results/bert-eval-noea-std-quail/eval_predictions.json
    metrics:
    - data/metrics/bert-eval-noea-std-quail/eval_metrics.json
  bert-train-race:
    cmd: ./src/processing/run.sh data/specs/bert-train-race_experiment.json
    deps:
    - data/RACE/dev
    - data/RACE/train
    - data/models/bert-base-uncased
    - src/processing/run.sh
    params:
    - data/specs/bert-train-race_experiment.json:
      - params.do_eval
      - params.do_train
      - params.fp16
      - params.fp16_opt_level
      - params.gradient_accumulation_steps
      - params.learning_rate
      - params.max_seq_length
      - params.meta
      - params.model_type
      - params.num_train_epochs
      - params.per_device_eval_batch_size
      - params.per_device_train_batch_size
      - params.task_name
      - params.warmup_steps
    outs:
    - data/RACE/cached_dev_BertTokenizer_484_race
    - data/RACE/cached_dev_BertTokenizer_484_race.lock
    - data/models/bert-train-race/config.json
    - data/models/bert-train-race/pytorch_model.bin
    - data/models/bert-train-race/special_tokens_map.json
    - data/models/bert-train-race/tokenizer_config.json
    - data/models/bert-train-race/training_args.bin
    - data/models/bert-train-race/vocab.txt
    - data/results/bert-train-race/eval_nbest_predictions.json
    - data/results/bert-train-race/eval_predictions.json
    - data/results/bert-train-race/train_nbest_predictions.json
    - data/results/bert-train-race/train_predictions.json
    metrics:
    - data/metrics/bert-train-race/eval_metrics.json
    - data/metrics/bert-train-race/train_metrics.json
  extract_no_empty_answers_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s train --args_file
      data/specs/bert-eval-no-empty-answers_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2 --oversample 0.5
    deps:
    - data/models/bert-train-no-empty-answers
    - data/quail_no_empty_answers/train.json
    - data/specs/bert-eval-no-empty-answers_experiment.json
    - src/etl/embeddings/extract/extract_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings
  extract_no_empty_answers_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/quail_no_empty_answers
      -s train -t generic -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths
    deps:
    - data/quail_no_empty_answers/train.json
    - src/etl/embeddings/extract/extract_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
  extract_no_empty_answers_lengths_oversample_05:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/
      -s train -t generic -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample
    deps:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/train.json
    - src/etl/embeddings/extract/extract_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
  extract_noea_model_std_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s dev --args_file
      data/specs/bert-eval-noea-std-quail_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/quail_noea_std_2
    deps:
    - data/models/bert-train-no-empty-answers
    - data/quail_race_fmt/dev.json
    - data/specs/bert-eval-noea-std-quail_experiment.json
    - src/etl/embeddings/extract/extract_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2/embeddings
  extract_noea_std_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/quail_race_fmt
      -s dev -t generic -o /data/gblanco/datasets/embeddings/quail_noea_std_2/dev_text_lengths
    deps:
    - data/quail_race_fmt/dev.json
    - src/etl/embeddings/extract/extract_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2/dev_text_lengths_data.pkl
  normalize_no_emtpy_answers_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
    deps:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/embeddings
    - src/etl/embeddings/transform/normalize_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
  normalize_no_emtpy_answers_embeddings_oversample_05:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
    deps:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_embeddings/embeddings
    - src/etl/embeddings/transform/normalize_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
  normalize_noea_std_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/quail_noea_std_2/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings
    deps:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2/embeddings
    - src/etl/embeddings/transform/normalize_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings
  merge_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_data.pkl
    - src/etl/embeddings/transform/merge_embeddings_and_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/normalized_embeddings_with_lengths
  merge_norm_with_lengths_oversample_05:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
      -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
      -o /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/train_text_lengths_oversample_data.pkl
    - src/etl/embeddings/transform/merge_embeddings_and_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2/oversample_normalized_embeddings_with_lengths
  merge_std_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/quail_noea_std_2/dev_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings
    - /data/gblanco/datasets/embeddings/quail_noea_std_2/dev_text_lengths_data.pkl
    - src/etl/embeddings/transform/merge_embeddings_and_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2/normalized_embeddings_with_lengths
  extract_std_race_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s train --args_file
      data/specs/bert-eval-race_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/std_race
    deps:
    - data/models/bert-train-race
    - data/quail_no_empty_answers/train.json
    - data/specs/bert-eval-race_experiment.json
    - src/etl/embeddings/extract/extract_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/std_race/embeddings
  extract_std_race_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/RACE
      -s train -t race -o /data/gblanco/datasets/embeddings/std_race/train_text_lengths
    deps:
    - data/RACE/train
    - src/etl/embeddings/extract/extract_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/std_race/train_text_lengths_data.pkl
  extract_std_race_dev_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s dev --args_file
      data/specs/bert-eval-race_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/std_race_dev
    deps:
    - data/models/bert-train-race
    - data/specs/bert-eval-race_experiment.json
    - src/etl/embeddings/extract/extract_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/std_race_dev/embeddings
  extract_std_race_dev_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/RACE
      -s dev -t race -o /data/gblanco/datasets/embeddings/std_race_dev/dev_text_lengths
    deps:
    - data/RACE/dev
    - src/etl/embeddings/extract/extract_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/std_race_dev/dev_text_lengths_data.pkl
  normalize_std_race_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/std_race/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/std_race/normalized_embeddings
    deps:
    - /data/gblanco/datasets/embeddings/std_race/embeddings
    - src/etl/embeddings/transform/normalize_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/std_race/normalized_embeddings
  normalize_std_race_dev_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/std_race_dev/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/std_race_dev/normalized_embeddings
    deps:
    - /data/gblanco/datasets/embeddings/std_race_dev/embeddings
    - src/etl/embeddings/transform/normalize_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/std_race_dev/normalized_embeddings
  merge_std_race_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/std_race/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/std_race/train_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/std_race/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - /data/gblanco/datasets/embeddings/std_race/normalized_embeddings
    - /data/gblanco/datasets/embeddings/std_race/train_text_lengths_data.pkl
    - src/etl/embeddings/transform/merge_embeddings_and_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/std_race/normalized_embeddings_with_lengths
  merge_std_race_dev_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/std_race_dev/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/std_race_dev/dev_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/std_race_dev/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - /data/gblanco/datasets/embeddings/std_race_dev/normalized_embeddings
    - /data/gblanco/datasets/embeddings/std_race_dev/dev_text_lengths_data.pkl
    - src/etl/embeddings/transform/merge_embeddings_and_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/std_race_dev/normalized_embeddings_with_lengths
  classification:
    cmd: python src/etl/embeddings/classify/classification.py -d /data/gblanco/datasets/embeddings/quail_no_empty_answers_2
      -o /data/gblanco/results/quail_no_empty_answers_2 --metrics_dir data/metrics/classification
      --train --eval
    deps:
    - /data/gblanco/datasets/embeddings/quail_no_empty_answers_2
    - src/etl/embeddings/classify/classification.py
    params:
    - classification
    - features
    outs:
    - /data/gblanco/results/quail_no_empty_answers_2
    metrics:
    - data/metrics/classification/scores.json:
        cache: false
  classifier_corrects_model:
    cmd: python src/etl/embeddings/transform/correct_predictions.py -c /data/gblanco/results/quail_no_empty_answers_2
      -e /data/gblanco/datasets/embeddings/quail_noea_std_2/ -o data/metrics/classifier_corrects_model
      --strategy no_answer --no_answer_text "not enough information" -d data/quail_race_fmt
      -s dev
    deps:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2
    - /data/gblanco/results/quail_no_empty_answers_2
    - data/quail_race_fmt
    - src/etl/embeddings/transform/correct_predictions.py
    params:
    - features
    metrics:
    - data/metrics/classifier_corrects_model/eval_nbest_predictions.json:
        cache: false
    - data/metrics/classifier_corrects_model/eval_predictions.json:
        cache: false
  evaluate_classifier_corrections:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/metrics/classifier_corrects_model/eval_nbest_predictions.json
      -m C_at_1 avg --task generic -o data/metrics/classifier_corrects_model/corrected_model_results.json
    deps:
    - data/metrics/classifier_corrects_model/eval_nbest_predictions.json
    - data/quail_race_fmt
    metrics:
    - data/metrics/classifier_corrects_model/corrected_model_results.json:
        cache: false
  classification_std_race:
    cmd: python src/etl/embeddings/classify/classification.py -d /data/gblanco/datasets/embeddings/std_race
      -o /data/gblanco/results/std_race --metrics_dir data/metrics/classification_std_race
      --train --eval
    deps:
    - /data/gblanco/datasets/embeddings/std_race
    - src/etl/embeddings/classify/classification.py
    params:
    - classification
    - features
    outs:
    - /data/gblanco/results/std_race
    metrics:
    - data/metrics/classification_std_race/scores.json:
        cache: false
  classifier_corrects_std_race_model:
    cmd: python src/etl/embeddings/transform/correct_predictions.py -c /data/gblanco/results/std_race
      -e /data/gblanco/datasets/embeddings/std_race/ -o data/metrics/classifier_corrects_std_race_model
      --strategy empty_answer -d data/RACE --task race
      -s dev
    deps:
    - /data/gblanco/datasets/embeddings/std_race
    - /data/gblanco/results/std_race
    - data/RACE
    - src/etl/embeddings/transform/correct_predictions.py
    params:
    - features
    metrics:
    - data/metrics/classifier_corrects_std_race_model/eval_nbest_predictions.json:
        cache: false
    - data/metrics/classifier_corrects_std_race_model/eval_predictions.json:
        cache: false
  evaluate_classifier_corrections_std_race_model:
    cmd: mcqa_utils -d data/RACE -n data/metrics/classifier_corrects_std_race_model/eval_nbest_predictions.json
      -m C_at_1 avg --task race -o data/metrics/classifier_corrects_std_race_model/corrected_model_results.json
    deps:
    - data/metrics/classifier_corrects_std_race_model/eval_nbest_predictions.json
    - data/quail_race_fmt
    metrics:
    - data/metrics/classifier_corrects_std_race_model/corrected_model_results.json:
        cache: false
  evaluate_bert:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/results/bert-train/eval_nbest_predictions.json
      -m C_at_1 avg --task generic -o data/metrics/bert-train/eval_mcqa.json
    deps:
    - data/quail_race_fmt
    - data/results/bert-train/eval_nbest_predictions.json
    metrics:
    - data/metrics/bert-train/eval_mcqa.json:
        cache: false
  evaluate_bert_noea_std_quail:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/results/bert-eval-noea-std-quail/eval_nbest_predictions.json
      -m C_at_1 avg --task generic -o data/metrics/bert-eval-noea-std-quail/eval_mcqa.json
    deps:
    - data/quail_race_fmt
    - data/results/bert-eval-noea-std-quail/eval_nbest_predictions.json
    metrics:
    - data/metrics/bert-eval-noea-std-quail/eval_mcqa.json:
        cache: false
  bert-eval-noea-mod-quail:
    cmd: ./src/processing/run.sh data/specs/bert-eval-noea-mod-quail_experiment.json
    deps:
    - data/models/bert-train-no-empty-answers
    - data/quail_empty_answers_removed/train.json
    - data/quail_empty_answers_removed/dev.json
    - src/processing/run.sh
    params:
    - data/specs/bert-eval-noea-mod-quail_experiment.json:
      - params.do_eval
      - params.do_train
      - params.fp16
      - params.fp16_opt_level
      - params.gradient_accumulation_steps
      - params.learning_rate
      - params.max_seq_length
      - params.meta
      - params.model_type
      - params.num_train_epochs
      - params.per_device_eval_batch_size
      - params.per_device_train_batch_size
      - params.task_name
      - params.warmup_steps
    outs:
    - data/results/bert-eval-noea-mod-quail/eval_nbest_predictions.json
    - data/results/bert-eval-noea-mod-quail/eval_predictions.json
    - data/models/bert-eval-noea-mod-quail/config.json
    - data/models/bert-eval-noea-mod-quail/pytorch_model.bin
    - data/models/bert-eval-noea-mod-quail/special_tokens_map.json
    - data/models/bert-eval-noea-mod-quail/tokenizer_config.json
    - data/models/bert-eval-noea-mod-quail/training_args.bin
    - data/models/bert-eval-noea-mod-quail/vocab.txt
    metrics:
    - data/metrics/bert-eval-noea-mod-quail/eval_metrics.json
  evaluate_bert_noea_mod_quail:
    cmd: mcqa_utils -d data/quail_empty_answers_removed -n data/results/bert-eval-noea-mod-quail/eval_nbest_predictions.json
      -m C_at_1 avg --task generic -o data/metrics/bert-eval-noea-mod-quail/eval_mcqa.json
    deps:
    - data/quail_empty_answers_removed
    - data/results/bert-eval-noea-mod-quail/eval_nbest_predictions.json
    metrics:
    - data/metrics/bert-eval-noea-mod-quail/eval_mcqa.json:
        cache: false
  evaluate_bert_race:
    cmd: mcqa_utils -d data/RACE -n data/results/bert-train-race/eval_nbest_predictions.json
      -m C_at_1 avg --task race -o data/metrics/bert-train-race/eval_mcqa.json
    deps:
    - data/RACE/dev/
    - data/results/bert-train-race/eval_nbest_predictions.json
    metrics:
    - data/metrics/bert-train-race/eval_mcqa.json:
        cache: false
  extract_std_quail_train_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s train --args_file
      data/specs/bert-eval_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/std_quail_train
    deps:
    - data/models/bert-train
    - data/quail_race_fmt/train.json
    - data/specs/bert-eval_experiment.json
    - src/etl/embeddings/extract/extract_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/std_quail_train/embeddings
  extract_std_quail_dev_embeddings:
    cmd: python src/etl/embeddings/extract/extract_embeddings.py -s dev --args_file
      data/specs/bert-eval_experiment.json --extract params --scatter_dataset
      -o /data/gblanco/datasets/embeddings/std_quail_dev
    deps:
    - data/models/bert-train
    - data/quail_race_fmt/dev.json
    - data/specs/bert-eval_experiment.json
    - src/etl/embeddings/extract/extract_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/std_quail_dev/embeddings
  extract_std_quail_train_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/quail_race_fmt
      -s train -t generic -o /data/gblanco/datasets/embeddings/std_quail_train/train_text_lengths
    deps:
    - data/quail_race_fmt/train
    - src/etl/embeddings/extract/extract_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/std_quail_train/train_text_lengths_data.pkl
  extract_std_quail_dev_lengths:
    cmd: python src/etl/embeddings/extract/extract_lengths.py -d data/quail_race_fmt
      -s dev -t generic -o /data/gblanco/datasets/embeddings/std_quail_dev/dev_text_lengths
    deps:
    - data/quail_race_fmt/dev
    - src/etl/embeddings/extract/extract_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/std_quail_dev/dev_text_lengths_data.pkl
  normalize_std_quail_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/std_quail_train/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/std_quail_train/normalized_embeddings
    deps:
    - /data/gblanco/datasets/embeddings/std_quail_train/embeddings
    - src/etl/embeddings/transform/normalize_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/std_quail_train/normalized_embeddings
  normalize_std_quail_dev_embeddings:
    cmd: python src/etl/embeddings/transform/normalize_embeddings.py -d /data/gblanco/datasets/embeddings/std_quail_dev/embeddings
      -n 50 --scatter_dataset -o /data/gblanco/datasets/embeddings/std_quail_dev/normalized_embeddings
    deps:
    - /data/gblanco/datasets/embeddings/std_quail_dev/embeddings
    - src/etl/embeddings/transform/normalize_embeddings.py
    outs:
    - /data/gblanco/datasets/embeddings/std_quail_dev/normalized_embeddings
  merge_std_quail_train_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/std_quail_train/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/std_quail_train/train_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/std_quail_train/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - /data/gblanco/datasets/embeddings/std_quail_train/normalized_embeddings
    - /data/gblanco/datasets/embeddings/std_quail_train/train_text_lengths_data.pkl
    - src/etl/embeddings/transform/merge_embeddings_and_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/std_quail_train/normalized_embeddings_with_lengths
  merge_std_quail_dev_norm_with_lengths:
    cmd: python src/etl/embeddings/transform/merge_embeddings_and_lengths.py -e /data/gblanco/datasets/embeddings/std_quail_dev/normalized_embeddings
      -d /data/gblanco/datasets/embeddings/std_quail_dev/dev_text_lengths_data.pkl
      -o /data/gblanco/datasets/embeddings/std_quail_dev/normalized_embeddings_with_lengths
      --scatter_dataset
    deps:
    - /data/gblanco/datasets/embeddings/std_quail_dev/normalized_embeddings
    - /data/gblanco/datasets/embeddings/std_quail_dev/dev_text_lengths_data.pkl
    - src/etl/embeddings/transform/merge_embeddings_and_lengths.py
    outs:
    - /data/gblanco/datasets/embeddings/std_quail_dev/normalized_embeddings_with_lengths
  classification_std_quail:
    cmd: python src/etl/embeddings/classify/classification.py -d /data/gblanco/datasets/embeddings/std_quail_train
      -o /data/gblanco/results/std_quail_train_classification --metrics_dir data/metrics/std_quail_train_classification
      --train --eval
    deps:
    - /data/gblanco/datasets/embeddings/std_quail_train
    - src/etl/embeddings/classify/classification.py
    params:
    - classification
    - features
    outs:
    - /data/gblanco/results/std_quail_train_classification
    metrics:
    - data/metrics/std_quail_train_classification/scores.json:
        cache: false
  classifier_corrects_model_no_answer:
    cmd: python src/etl/embeddings/transform/correct_predictions.py -c /data/gblanco/results/std_quail_train_classification
      -e /data/gblanco/datasets/embeddings/std_quail_dev/ -o data/metrics/std_quail_corrects_model_no_answer
      --strategy no_answer --no_answer_text "not enough information" -d data/quail_race_fmt
      -s dev
    deps:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2
    - /data/gblanco/results/std_quail_train_classification
    - data/quail_race_fmt
    - src/etl/embeddings/transform/correct_predictions.py
    params:
    - features
    metrics:
    - data/metrics/std_quail_corrects_model_no_answer/eval_nbest_predictions.json:
        cache: false
    - data/metrics/std_quail_corrects_model_no_answer/eval_predictions.json:
        cache: false
    - data/metrics/std_quail_corrects_model_no_answer/original_eval_nbest_predictions.json:
        cache: false
    - data/metrics/std_quail_corrects_model_no_answer/original_eval_predictions.json:
        cache: false
  evaluate_classifier_corrections_no_answer:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/metrics/std_quail_corrects_model_no_answer/eval_nbest_predictions.json
      -m avg --task generic -o data/metrics/std_quail_corrects_model_no_answer/corrected_model_results.json
    deps:
    - data/metrics/std_quail_corrects_model_no_answer/eval_nbest_predictions.json
    - data/quail_race_fmt
    metrics:
    - data/metrics/std_quail_corrects_model_no_answer/corrected_model_results.json:
        cache: false
  evaluate_classifier_corrections_original:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/metrics/std_quail_corrects_model_no_answer/original_eval_nbest_predictions.json
      -m avg --task generic -o data/metrics/std_quail_corrects_model_no_answer/original_model_results.json
    deps:
    - data/metrics/std_quail_corrects_model_no_answer/original_eval_nbest_predictions.json
    - data/quail_race_fmt
    metrics:
    - data/metrics/std_quail_corrects_model_no_answer/original_model_results.json:
        cache: false
  classifier_corrects_model_empty_answer:
    cmd: python src/etl/embeddings/transform/correct_predictions.py -c /data/gblanco/results/std_quail_train_classification
      -e /data/gblanco/datasets/embeddings/std_quail_dev/ -o data/metrics/std_quail_corrects_model_empty_answer
      --strategy empty_answer -d data/quail_race_fmt
      -s dev
    deps:
    - /data/gblanco/datasets/embeddings/quail_noea_std_2
    - /data/gblanco/results/std_quail_train_classification
    - data/quail_race_fmt
    - src/etl/embeddings/transform/correct_predictions.py
    params:
    - features
    metrics:
    - data/metrics/std_quail_corrects_model_empty_answer/eval_nbest_predictions.json:
        cache: false
    - data/metrics/std_quail_corrects_model_empty_answer/eval_predictions.json:
        cache: false
    - data/metrics/std_quail_corrects_model_empty_answer/original_eval_nbest_predictions.json:
        cache: false
    - data/metrics/std_quail_corrects_model_empty_answer/original_eval_predictions.json:
        cache: false
  evaluate_classifier_corrections_empty_answer:
    cmd: mcqa_utils -d data/quail_race_fmt -n data/metrics/std_quail_corrects_model_empty_answer/eval_nbest_predictions.json
      -m avg --task generic -o data/metrics/std_quail_corrects_model_empty_answer/corrected_model_results.json
    deps:
    - data/metrics/std_quail_corrects_model_empty_answer/eval_nbest_predictions.json
    - data/quail_race_fmt
    metrics:
    - data/metrics/std_quail_corrects_model_empty_answer/corrected_model_results.json:
        cache: false
